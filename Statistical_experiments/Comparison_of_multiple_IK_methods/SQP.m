function [q,exitflag,t,k]=SQP(Td,q0,para)
% Input
% Td: desired end pose;
% q0: initial guess;
% para: parameters of manipulator.
% Output
% q: IK solution;
% exitflag: exit flag whose value is 0 (failure) or 1 (success);
% t: runtime;
% k: number of iterations.

t_sqp=tic;
exitflag=0;
max_time=50e-3;     % Max runtime
options=optimoptions('fmincon','Algorithm','sqp',...
    'Display','off','MaxIterations',1000,...
    'ObjectiveLimit',1e-12,'MaxFunctionEvaluations',1000,...
    'OptimalityTolerance',1e-12,'StepTolerance',1e-7);
a=para.a; d=para.d;
qlim=para.qlim;
A=[]; b=[]; Aeq=[]; beq=[];
lb=qlim(:,1)'; ub=qlim(:,2)';
nonlcon=[];
k=0;

while toc(t_sqp)<max_time
    [q,fval,~,output]=fmincon(@(q)obj(q,Td,a,d),q0,A,b,Aeq,beq,lb,ub,...
        nonlcon,options);
    t=toc(t_sqp);
    k=k+output.iterations;
    if k>options.MaxIterations
        break
    end
    if fval<options.ObjectiveLimit && if_qlim(q,qlim) && t<max_time
        exitflag=1;
        return
    else
        q0=qlim(:,1)+(qlim(:,2)-qlim(:,1)).*rand(7,1);
    end
end

    function err=obj(q,Td,a,d)
        % Objective function
        a2=a(2);a3=a(3);a4=a(4);a5=a(5);a8=a(8);
        d1=d(1);d7=d(7);d11=d(11);
        q1=q(1);q2=q(2);q3=q(3);q5=q(4);q7=q(5);q8=q(6);q11=q(7);
        Tc=[(-1).*sin(q11+(-1).*q7).*(cos(q7).*sin(q1)+cos(q1).*cos(q2+2.*( ...
            q3+q5)).*sin(q7))+cos(q11+(-1).*q7).*(cos(2.*q8).*(cos(q1).*cos( ...
            q2+2.*(q3+q5)).*cos(q7)+(-1).*sin(q1).*sin(q7))+(-1).*cos(q1).* ...
            sin(q2+2.*(q3+q5)).*sin(2.*q8)),(-1).*cos(q11+(-1).*q7).*(cos(q7) ...
            .*sin(q1)+cos(q1).*cos(q2+2.*(q3+q5)).*sin(q7))+(-1).*sin(q11+(-1) ...
            .*q7).*(cos(2.*q8).*(cos(q1).*cos(q2+2.*(q3+q5)).*cos(q7)+(-1).* ...
            sin(q1).*sin(q7))+(-1).*cos(q1).*sin(q2+2.*(q3+q5)).*sin(2.*q8)), ...
            sin(q1).*sin(q7).*sin(2.*q8)+(-1).*cos(q1).*(cos(2.*q8).*sin(q2+ ...
            2.*(q3+q5))+cos(q2+2.*(q3+q5)).*cos(q7).*sin(2.*q8)),(-1).*cos(q1) ...
            .*(a2.*sin(q2)+a3.*sin(q2+q3)+a4.*sin(q2+2.*q3)+a5.*sin(q2+2.*q3+ ...
            q5)+(d7+a8.*cos(q8)+d11.*cos(2.*q8)).*sin(q2+2.*(q3+q5)))+(-1).* ...
            cos(q1).*cos(q2+2.*(q3+q5)).*cos(q7).*(a8+2.*d11.*cos(q8)).*sin( ...
            q8)+(a8+2.*d11.*cos(q8)).*sin(q1).*sin(q7).*sin(q8);(-1).*sin(q11+ ...
            (-1).*q7).*((-1).*cos(q1).*cos(q7)+cos(q2+2.*(q3+q5)).*sin(q1).* ...
            sin(q7))+cos(q11+(-1).*q7).*(cos(2.*q8).*(cos(q2+2.*(q3+q5)).*cos( ...
            q7).*sin(q1)+cos(q1).*sin(q7))+(-1).*sin(q1).*sin(q2+2.*(q3+q5)).* ...
            sin(2.*q8)),cos(q11+(-1).*q7).*(cos(q1).*cos(q7)+(-1).*cos(q2+2.*( ...
            q3+q5)).*sin(q1).*sin(q7))+(-1).*sin(q11+(-1).*q7).*(cos(2.*q8).*( ...
            cos(q2+2.*(q3+q5)).*cos(q7).*sin(q1)+cos(q1).*sin(q7))+(-1).*sin( ...
            q1).*sin(q2+2.*(q3+q5)).*sin(2.*q8)),(-1).*cos(2.*q8).*sin(q1).* ...
            sin(q2+2.*(q3+q5))+(-1).*(cos(q2+2.*(q3+q5)).*cos(q7).*sin(q1)+ ...
            cos(q1).*sin(q7)).*sin(2.*q8),(-1).*sin(q1).*(a2.*sin(q2)+a3.*sin( ...
            q2+q3)+a4.*sin(q2+2.*q3)+a5.*sin(q2+2.*q3+q5)+(d7+a8.*cos(q8)+ ...
            d11.*cos(2.*q8)).*sin(q2+2.*(q3+q5)))+(-1).*cos(q2+2.*(q3+q5)).* ...
            cos(q7).*(a8+2.*d11.*cos(q8)).*sin(q1).*sin(q8)+(-1).*cos(q1).*( ...
            a8+2.*d11.*cos(q8)).*sin(q7).*sin(q8);(-1).*sin(q2+2.*(q3+q5)).* ...
            sin(q11+(-1).*q7).*sin(q7)+cos(q11+(-1).*q7).*(cos(q7).*cos(2.*q8) ...
            .*sin(q2+2.*(q3+q5))+cos(q2+2.*(q3+q5)).*sin(2.*q8)),(-1).*cos( ...
            q11+(-1).*q7).*sin(q2+2.*(q3+q5)).*sin(q7)+(-1).*sin(q11+(-1).*q7) ...
            .*(cos(q7).*cos(2.*q8).*sin(q2+2.*(q3+q5))+cos(q2+2.*(q3+q5)).* ...
            sin(2.*q8)),cos(q2+2.*(q3+q5)).*cos(2.*q8)+(-1).*cos(q7).*sin(q2+ ...
            2.*(q3+q5)).*sin(2.*q8),d1+a2.*cos(q2)+a3.*cos(q2+q3)+a4.*cos(q2+ ...
            2.*q3)+a5.*cos(q2+2.*q3+q5)+cos(q2+2.*(q3+q5)).*(d7+a8.*cos(q8)+ ...
            d11.*cos(2.*q8))+(-1).*cos(q7).*(a8+2.*d11.*cos(q8)).*sin(q2+2.*( ...
            q3+q5)).*sin(q8);0,0,0,1];
        ep=Td(1:3,4)-Tc(1:3,4);
        [etheta,ev]=tr2angvec(Td(1:3,1:3)*(Tc(1:3,1:3)'));
        eo=etheta*ev';
        epo=[ep;eo];
        err=epo'*epo;
    end
end